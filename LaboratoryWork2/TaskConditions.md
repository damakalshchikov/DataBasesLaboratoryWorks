# Лабораторная работа №2 - Практические задания по MongoDB
## Раздел 1: Выборка документов и работа с массивами (Задания 1-10)

### Задание 1
Сформируйте запросы для вывода списков самцов и самок единорогов. Ограничьте список самок первыми тремя особями. Отсортируйте списки по имени.

**Требования:**
- Выборка по полю `gender`
- Лимит для самок: 3 документа
- Сортировка по полю `name`

---

### Задание 2
Найдите всех самок, которые любят `carrot`. Ограничьте этот список первой особью с помощью функций `findOne` и `limit`.

**Требования:**
- Условие: `gender: 'f'` и `loves: 'carrot'`
- Два варианта решения: через `findOne()` и через `limit(1)`

---

### Задание 3
Модифицируйте запрос для вывода списков самцов единорогов, исключив из результата информацию о предпочтениях и поле.

**Требования:**
- Выборка: `gender: 'm'`
- Исключить поля: `loves`, `gender`
- Использовать проекцию с `0`

---

### Задание 4
Вывести список единорогов в обратном порядке добавления.

**Требования:**
- Использовать `$natural: -1` для обратной сортировки
- Вернуть документы в порядке, обратном их вставке

---

### Задание 5
Вывести список единорогов с названием первого любимого предпочтения, исключив идентификатор.

**Требования:**
- Использовать `$slice: 1` для массива `loves`
- Исключить поле `_id`
- Показать только первый элемент массива предпочтений

---

### Задание 6
Вывести список самок единорогов весом от полутонны до 700 кг, исключив вывод идентификатора.

**Требования:**
- Условия: `gender: 'f'`, `weight: {$gte: 500, $lte: 700}`
- Исключить `_id` из результата

---

### Задание 7
Вывести список самцов единорогов весом от полутонны и предпочитающих `grape` и `lemon`, исключив вывод идентификатора.

**Требования:**
- Условия: `gender: 'm'`, `weight >= 500`
- Массив `loves` должен содержать и `grape`, и `lemon` (использовать `$all`)
- Исключить `_id`

---

### Задание 8
Найти всех единорогов, не имеющих ключ `vampires`.

**Требования:**
- Использовать оператор `$exists: false`
- Найти документы без поля `vampires`

---

### Задание 9
Вывести упорядоченный список имен самцов единорогов с информацией об их первом предпочтении.

**Требования:**
- Выборка: `gender: 'm'`
- Показать `name` и первый элемент `loves` (`$slice: 1`)
- Сортировка по `name`

---

### Задание 10
Создайте коллекцию `towns`, включающую следующие документы:

```javascript
{
  name: "Punxsutawney",
  population: 6200,
  last_census: ISODate("2008-01-31"),
  famous_for: [""],
  mayor: {
    name: "Jim Wehrle"
  }
}

{
  name: "New York",
  population: 22200000,
  last_census: ISODate("2009-07-31"),
  famous_for: ["status of liberty", "food"],
  mayor: {
    name: "Michael Bloomberg",
    party: "I"
  }
}

{
  name: "Portland",
  population: 528000,
  last_census: ISODate("2009-07-20"),
  famous_for: ["beer", "food"],
  mayor: {
    name: "Sam Adams",
    party: "D"
  }
}
```

**Подзадачи:**
1. Сформируйте запрос, который возвращает список городов с независимыми мэрами (`party="I"`). Вывести только название города и информацию о мэре.
2. Сформируйте запрос, который возвращает список беспартийных мэров (поле `party` отсутствует). Вывести только название города и информацию о мэре.

**Примечание:** Максимальная оценка за задания 1-10 составляет 35 баллов.

---

## Раздел 2: Курсоры (Задание 11)

### Задание 11
Сформировать функцию для вывода списка самцов единорогов. Создать курсор для этого списка из первых двух особей с сортировкой в лексикографическом порядке. Вывести результат, используя `forEach`.

**Требования:**
- Создать функцию JavaScript для выборки
- Создать курсор с условием `gender: 'm'`
- Применить `sort({name: 1}).limit(2)`
- Использовать `cursor.forEach()` для вывода

---

## Раздел 3: Агрегированные запросы (Задания 12-14)

### Задание 12
Вывести количество самок единорогов весом от полутонны до 600 кг.

**Требования:**
- Использовать метод `count()`
- Условия: `gender: 'f'`, `weight: {$gte: 500, $lte: 600}`

---

### Задание 13
Вывести список предпочтений (уникальных значений).

**Требования:**
- Использовать метод `distinct("loves")`
- Получить все уникальные значения из массива `loves`

---

### Задание 14
Посчитать количество особей единорогов обоих полов.

**Требования:**
- Использовать метод `aggregate()`
- Группировка по полю `gender`
- Подсчет количества документов для каждого пола с помощью `$sum: 1`

**Пример структуры:**
```javascript
db.unicorns.aggregate([
  {
    $group: {
      _id: "$gender",
      count: {$sum: 1}
    }
  }
])
```

---

## Раздел 4: Редактирование данных (Задания 15-21)

### Задание 15
Выполнить команду:
```javascript
db.unicorns.save({
  name: 'Barny',
  loves: ['grape'],
  weight: 340,
  gender: 'm'
})
```

Проверить содержимое коллекции `unicorns`.

**Требования:**
- Использовать метод `save()`
- Убедиться, что документ добавлен (проверить через `find()`)

---

### Задание 16
Для самки единорога `Ayna` внести изменения в БД: теперь ее вес 800, она убила 51 вампира. Проверить содержимое коллекции `unicorns`.

**Требования:**
- Использовать метод `update()` или `updateOne()`
- Условие: `name: 'Ayna'`
- Изменить: `weight: 800`, `vampires: 51`

---

### Задание 17
Для самца единорога `Raleigh` внести изменения в БД: теперь он любит редбул. Проверить содержимое коллекции `unicorns`.

**Требования:**
- Использовать оператор `$set`
- Добавить в массив `loves` значение `'redbull'` или заменить массив

---

### Задание 18
Всем самцам единорогов увеличить количество убитых вампиров на 5. Проверить содержимое коллекции `unicorns`.

**Требования:**
- Использовать оператор `$inc`
- Условие: `gender: 'm'`
- Увеличить `vampires` на 5
- Установить `multi: true` для обновления всех документов

---

### Задание 19
Изменить информацию о городе Портланд: мэр этого города теперь беспартийный. Проверить содержимое коллекции `towns`.

**Требования:**
- Использовать оператор `$unset`
- Условие: `name: "Portland"`
- Удалить поле `mayor.party`

---

### Задание 20
Изменить информацию о самце единорога `Pilot`: теперь он любит и шоколад. Проверить содержимое коллекции `unicorns`.

**Требования:**
- Использовать оператор `$push`
- Условие: `name: 'Pilot'`
- Добавить `'chocolate'` в массив `loves`

---

### Задание 21
Изменить информацию о самке единорога `Aurora`: теперь она любит еще и сахар, и лимоны. Проверить содержимое коллекции `unicorns`.

**Требования:**
- Использовать оператор `$addToSet` с `$each`
- Условие: `name: 'Aurora'`
- Добавить `['sugar', 'lemon']` в массив `loves` (только если их там еще нет)

---

## Раздел 5: Удаление данных (Задание 22)

### Задание 22
Создайте коллекцию `towns`, включающую следующие документы:

```javascript
{
  name: "Punxsutawney",
  population: 6200,
  last_census: ISODate("2008-01-31"),
  famous_for: ["phil the groundhog"],
  mayor: {
    name: "Jim Wehrle"
  }
}

{
  name: "New York",
  population: 22200000,
  last_census: ISODate("2009-07-31"),
  famous_for: ["status of liberty", "food"],
  mayor: {
    name: "Michael Bloomberg",
    party: "I"
  }
}

{
  name: "Portland",
  population: 528000,
  last_census: ISODate("2009-07-20"),
  famous_for: ["beer", "food"],
  mayor: {
    name: "Sam Adams",
    party: "D"
  }
}
```

**Подзадачи:**
1. Удалите документы с беспартийными мэрами (где поле `party` отсутствует)
2. Проверьте содержание коллекции
3. Очистите коллекцию (удалите все документы)
4. Просмотрите список доступных коллекций

**Требования:**
- Использовать `remove()` с условием `{"mayor.party": {$exists: false}}`
- Использовать `remove({})` для полной очистки
- Использовать `show collections` для просмотра списка коллекций

---

## Раздел 6: Ссылки между коллекциями (Задание 23)

### Задание 23
Создайте коллекцию зон обитания единорогов, указав в качестве идентификатора кратко название зоны, далее включив полное название и описание.

Включите для нескольких единорогов в документы ссылку на зону обитания, используя второй способ автоматического связывания (DBRef).

Проверьте содержание коллекции единорогов.

**Требования:**
1. Создать коллекцию `habitats` с документами вида:
   ```javascript
   {
     _id: "forest",
     fullName: "Enchanted Forest",
     description: "Dense magical forest with ancient trees"
   }
   ```

2. Добавить ссылки в коллекцию `unicorns`:
   ```javascript
   db.unicorns.update(
     {name: "Horny"},
     {$set: {habitat: {$ref: "habitats", $id: "forest"}}}
   )
   ```

3. Проверить, что ссылки работают, получив данные из связанной коллекции

---

## Раздел 7: Работа с индексами (Задания 24-25)

### Задание 24
Проверьте, можно ли задать для коллекции `unicorns` индекс для ключа `name` с флагом `unique`.

**Требования:**
- Попытаться создать индекс: `db.unicorns.createIndex({name: 1}, {unique: true})`
- Проанализировать результат (удастся ли создать индекс с учетом того, что в коллекции есть документы с одинаковыми именами?)

---

### Задание 25
Получите информацию о всех индексах коллекции `unicorns`.
Удалите все индексы, кроме индекса для идентификатора.
Попытайтесь удалить индекс для идентификатора.

**Требования:**
- Использовать `db.unicorns.getIndexes()` для просмотра
- Использовать `db.unicorns.dropIndex("index_name")` для удаления
- Попытаться удалить индекс `_id_` (должна быть ошибка, т.к. это обязательный индекс)

---

## Раздел 8: План запроса и оптимизация (Задание 26)

### Задание 26
Создайте объемную коллекцию `numbers`, задействовав курсор:
```javascript
for(i = 0; i < 100000; i++){
  db.numbers.insert({value: i})
}
```

**Подзадачи:**
1. Выберите последние четыре документа
2. Проанализируйте план выполнения запроса. Сколько потребовалось времени на выполнение запроса? (по значению параметра `executionTimeMillis`)
3. Создайте индекс для ключа `value`
4. Получите информацию о всех индексах коллекции `numbers`
5. Выполните запрос из пункта 1 снова
6. Проанализируйте план выполнения запроса с установленным индексом. Сколько потребовалось времени на выполнение запроса?
7. Сравните время выполнения запросов с индексом и без. Дайте ответ на вопрос: какой запрос более эффективен?

**Требования:**
- Запрос: `db.numbers.find().sort({value: -1}).limit(4)`
- Анализ: `db.numbers.explain("executionStats").find().sort({value: -1}).limit(4)`
- Создание индекса: `db.numbers.createIndex({value: 1})`
- Сравнить параметры: `executionTimeMillis`, `totalDocsExamined`, тип сканирования (`COLLSCAN` vs `IXSCAN`)

---

## Контрольные вопросы для защиты лабораторной работы

1. Как используется оператор точка?
2. Как можно использовать курсор?
3. Какие возможности агрегирования данных существуют в MongoDB?
4. Какая из функций `save` или `update` более детально позволит настроить редактирование документов коллекции?
5. Как происходит удаление документов из коллекции по умолчанию?
6. Назовите способы связывания коллекций в MongoDB.
7. Сколько индексов можно установить на одну коллекцию в БД MongoDB?
8. Как получить информацию о всех индексах базы данных MongoDB?

---

## Рекомендации по выполнению

- **Коллекция unicorns** создается в лабораторной работе №1
- Все команды выполняются в MongoDB Shell (`mongosh`) или через MongoDB Compass
- Рекомендуется сохранять запросы в файлы `.js` для удобства повторного использования
- После каждого изменения проверяйте результат через `db.collection.find()`
- Используйте `db.collection.find().pretty()` для красивого форматирования вывода

---

## Полезные команды для работы

```javascript
// Переключение на базу данных
use learn

// Просмотр всех коллекций
show collections

// Просмотр содержимого коллекции
db.unicorns.find()
db.unicorns.find().pretty()

// Подсчет документов
db.unicorns.count()

// Удаление коллекции
db.unicorns.drop()

// Статистика по базе данных
db.stats()
```

---

**Дата создания:** 2025  
**Преподаватель:** Бычков С.Ю.  
**Направление:** 09.03.03 «Прикладная информатика»
